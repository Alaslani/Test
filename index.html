<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f7f4;--surface:#ffffff;--card:#ffffff;--card-hover:#fafaf8;
  --border:#e8e5de;--border-h:#d4d0c8;
  --text:#2c2a25;--text2:#6b6860;--text3:#9c978d;
  --accent:#d97706;--accent2:#b45309;--accent-bg:#fef3c7;--accent-border:#fde68a;
  --green:#059669;--green-bg:#d1fae5;--green-border:#6ee7b7;
  --amber:#d97706;--amber-bg:#fef3c7;--amber-border:#fcd34d;
  --red:#dc2626;--red-bg:#fee2e2;--red-border:#fca5a5;
  --purple:#7c3aed;--purple-bg:#ede9fe;--purple-border:#c4b5fd;
  --cyan:#0891b2;--cyan-bg:#cffafe;--cyan-border:#67e8f9;
  --blue:#2563eb;--blue-bg:#dbeafe;--blue-border:#93c5fd;
  --radius:18px;--radius-sm:12px;--radius-xs:8px;
  --shadow:0 1px 3px rgba(0,0,0,.04),0 4px 16px rgba(0,0,0,.04);
  --shadow-lg:0 4px 24px rgba(0,0,0,.08);
  --font:'IBM Plex Sans Arabic','Tajawal',sans-serif;
}
html{font-size:15px}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;line-height:1.7}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

.role-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:2rem;background:linear-gradient(160deg,#fefcf3 0%,#f0ebe3 50%,#e8e3d8 100%)}
.role-screen h1{font-size:2.6rem;font-weight:800;margin-bottom:.4rem;color:var(--text);letter-spacing:-.5px}
.role-screen p{color:var(--text2);margin-bottom:3rem;font-size:1.05rem}
.role-cards{display:flex;gap:1.5rem;flex-wrap:wrap;justify-content:center;max-width:900px}
.role-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:2.5rem 2rem;width:260px;text-align:center;cursor:pointer;transition:all .35s cubic-bezier(.4,0,.2,1);box-shadow:var(--shadow)}
.role-card:hover{transform:translateY(-6px);border-color:var(--accent-border);box-shadow:0 8px 32px rgba(217,119,6,.12)}
.role-icon{width:72px;height:72px;border-radius:20px;margin:0 auto 1.2rem;display:flex;align-items:center;justify-content:center;font-size:1.9rem}
.role-card:nth-child(1) .role-icon{background:#fef3c7;border:1px solid #fde68a}
.role-card:nth-child(2) .role-icon{background:#ede9fe;border:1px solid #c4b5fd}
.role-card:nth-child(3) .role-icon{background:#d1fae5;border:1px solid #6ee7b7}
.role-card h3{font-size:1.15rem;font-weight:700;margin-bottom:.4rem}
.role-card span{color:var(--text2);font-size:.85rem}

.app{display:none;min-height:100vh}.app.active{display:flex;flex-direction:column}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:1rem 2rem;border-bottom:1px solid var(--border);background:rgba(255,255,255,.85);backdrop-filter:blur(20px);position:sticky;top:0;z-index:40}
.topbar-right{display:flex;align-items:center;gap:1rem}
.topbar h2{font-size:1.1rem;font-weight:700}
.topbar .user-role{font-size:.75rem;color:var(--accent);background:var(--accent-bg);padding:3px 14px;border-radius:20px;border:1px solid var(--accent-border);font-weight:600}
.btn-back{background:none;border:1px solid var(--border);color:var(--text2);padding:6px 18px;border-radius:var(--radius-xs);cursor:pointer;font-family:var(--font);font-size:.85rem;transition:all .2s}
.btn-back:hover{border-color:var(--border-h);color:var(--text);background:var(--card-hover)}
.main{padding:2rem;max-width:1200px;margin:0 auto;width:100%}

.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1.2rem 1.5rem;box-shadow:var(--shadow)}
.stat-card .label{font-size:.8rem;color:var(--text3);margin-bottom:.3rem;font-weight:500}
.stat-card .value{font-size:1.8rem;font-weight:800}

.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem}
.section-header h3{font-size:1.15rem;font-weight:700}

.btn{padding:8px 20px;border-radius:var(--radius-xs);border:none;font-family:var(--font);font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent2)}
.btn-outline{background:none;border:1px solid var(--border);color:var(--text2)}.btn-outline:hover{border-color:var(--border-h);color:var(--text);background:var(--card-hover)}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:#047857}
.btn-amber{background:var(--amber-bg);color:#92400e;border:1px solid var(--amber-border)}
.btn-sm{padding:5px 14px;font-size:.78rem}
.btn-whatsapp{background:#25D366;color:#fff;border:none}.btn-whatsapp:hover{background:#1da851}

.list{display:flex;flex-direction:column;gap:.8rem}
.list-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1.2rem 1.5rem;transition:all .2s;cursor:pointer;box-shadow:var(--shadow)}
.list-item:hover{border-color:var(--border-h);box-shadow:var(--shadow-lg)}
.list-item-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem}
.list-item h4{font-size:1rem;font-weight:600}
.list-item p{font-size:.85rem;color:var(--text2)}
.list-item .meta{display:flex;gap:1rem;margin-top:.6rem;flex-wrap:wrap}
.list-item .meta span{font-size:.78rem;color:var(--text3);display:flex;align-items:center;gap:4px}

.badge{display:inline-block;padding:3px 12px;border-radius:20px;font-size:.75rem;font-weight:600}
.badge-blue{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border)}
.badge-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border)}
.badge-amber{background:var(--amber-bg);color:#92400e;border:1px solid var(--amber-border)}
.badge-red{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border)}
.badge-purple{background:var(--purple-bg);color:var(--purple);border:1px solid var(--purple-border)}
.badge-cyan{background:var(--cyan-bg);color:var(--cyan);border:1px solid var(--cyan-border)}

.modal-overlay{position:fixed;inset:0;background:rgba(44,42,37,.35);backdrop-filter:blur(6px);z-index:100;display:none;align-items:center;justify-content:center;padding:1.5rem}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:560px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.12)}
.modal.wide{max-width:800px}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:1.5rem 1.8rem 1rem;border-bottom:1px solid var(--border)}
.modal-header h3{font-size:1.1rem;font-weight:700}
.modal-close{background:none;border:none;color:var(--text3);font-size:1.3rem;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all .2s}
.modal-close:hover{background:var(--card-hover);color:var(--text)}
.modal-body{padding:1.5rem 1.8rem}

.form-group{margin-bottom:1.2rem}
.form-group label{display:block;font-size:.85rem;color:var(--text2);margin-bottom:.4rem;font-weight:500}
.form-group input,.form-group textarea,.form-group select{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-xs);color:var(--text);font-family:var(--font);font-size:.9rem;transition:border-color .2s}
.form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(217,119,6,.1)}
.form-group textarea{min-height:80px;resize:vertical}

.chips{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.4rem}
.chip{padding:6px 14px;border-radius:20px;font-size:.8rem;cursor:pointer;border:1px solid var(--border);color:var(--text2);background:var(--bg);transition:all .2s;font-family:var(--font)}
.chip.selected{background:var(--accent-bg);color:#92400e;border-color:var(--accent-border)}
.chip:hover{border-color:var(--border-h)}

.ai-box{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1px solid var(--accent-border);border-radius:var(--radius-sm);padding:1.5rem;margin-top:1rem;position:relative;overflow:hidden}
.ai-box::before{content:'âœ¦ ØªØ­Ù„ÙŠÙ„ AI';position:absolute;top:0;right:0;background:linear-gradient(135deg,var(--accent),#92400e);color:#fff;font-size:.7rem;font-weight:700;padding:4px 14px;border-radius:0 0 0 var(--radius-xs)}
.ai-box h4{margin-top:1rem;font-size:1rem;font-weight:700;margin-bottom:.8rem}
.ai-score{display:flex;align-items:center;gap:.8rem;margin-bottom:.5rem;padding:.8rem 1rem;background:var(--surface);border-radius:var(--radius-xs);border:1px solid var(--border)}
.ai-score .rank{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.85rem;flex-shrink:0}
.ai-score .rank.gold{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
.ai-score .rank.silver{background:linear-gradient(135deg,#94a3b8,#64748b);color:#fff}
.ai-score .rank.bronze{background:linear-gradient(135deg,#b45309,#92400e);color:#fff}
.ai-score .details{flex:1}.ai-score .details h5{font-size:.9rem;font-weight:600}.ai-score .details p{font-size:.78rem;color:var(--text2)}
.ai-score .score-val{font-size:1.2rem;font-weight:800;color:var(--green)}
.ai-recommendation{margin-top:1rem;padding:1rem;background:var(--green-bg);border:1px solid var(--green-border);border-radius:var(--radius-xs);font-size:.85rem;color:#065f46}

.timeline{position:relative;padding-right:2rem}
.timeline::before{content:'';position:absolute;right:7px;top:0;bottom:0;width:2px;background:var(--border)}
.timeline-item{position:relative;padding-bottom:1.5rem}
.timeline-item::before{content:'';position:absolute;right:-2rem;top:6px;width:12px;height:12px;border-radius:50%;background:var(--accent);border:2px solid var(--bg);z-index:1}
.timeline-item.done::before{background:var(--green)}
.timeline-item .t-date{font-size:.75rem;color:var(--text3);margin-bottom:.2rem}
.timeline-item .t-content{font-size:.88rem;color:var(--text2)}
.timeline-item .t-user{font-size:.75rem;color:var(--accent);margin-top:.2rem}

.tabs{display:flex;gap:0;margin-bottom:1.5rem;border-bottom:2px solid var(--border)}
.tab{padding:.8rem 1.5rem;font-size:.88rem;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;margin-bottom:-2px;font-family:var(--font);background:none;border-top:none;border-left:none;border-right:none;font-weight:500}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.tab:hover{color:var(--text2)}

.quote-table{width:100%;border-collapse:separate;border-spacing:0;font-size:.85rem}
.quote-table th{text-align:right;padding:.8rem 1rem;color:var(--text3);font-weight:600;border-bottom:2px solid var(--border);font-size:.78rem;background:var(--bg)}
.quote-table td{padding:.8rem 1rem;border-bottom:1px solid var(--border)}
.quote-table tr:hover td{background:var(--card-hover)}
.quote-table .best-row td{background:var(--green-bg);border-color:var(--green-border)}

.wa-preview{background:#e5ddd5;border-radius:var(--radius-sm);padding:1.2rem;font-size:.88rem;line-height:1.8;background-image:url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23c7bfb0' fill-opacity='.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E")}
.wa-bubble{background:#dcf8c6;color:#303030;padding:.8rem 1rem;border-radius:12px 12px 4px 12px;max-width:85%;margin-bottom:.5rem;box-shadow:0 1px 2px rgba(0,0,0,.08)}
.wa-bubble .wa-time{font-size:.65rem;color:#00000050;text-align:left;margin-top:.3rem}

.empty-state{text-align:center;padding:4rem 2rem;color:var(--text3)}.empty-state .empty-icon{font-size:3rem;margin-bottom:1rem;opacity:.5}.empty-state p{font-size:.95rem}

@keyframes fadeUp{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp .5s ease both}.fade-up-1{animation-delay:.05s}.fade-up-2{animation-delay:.1s}.fade-up-3{animation-delay:.15s}.fade-up-4{animation-delay:.2s}

@media(max-width:700px){.role-cards{flex-direction:column;align-items:center}.stats{grid-template-columns:1fr 1fr}.topbar{padding:.8rem 1rem}.main{padding:1.2rem}.role-screen h1{font-size:1.8rem}}
</style>
</head>
<body>

<div class="role-screen" id="roleScreen">
  <h1 class="fade-up">Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª â˜€ï¸</h1>
  <p class="fade-up fade-up-1">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
  <div class="role-cards">
    <div class="role-card fade-up fade-up-2" onclick="selectRole('delegate')"><div class="role-icon">ğŸ“‹</div><h3>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h3><span>Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª</span></div>
    <div class="role-card fade-up fade-up-3" onclick="selectRole('supervisor')"><div class="role-icon">ğŸ“Š</div><h3>Ø§Ù„Ù…Ø´Ø±Ù</h3><span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</span></div>
    <div class="role-card fade-up fade-up-4" onclick="selectRole('delivery')"><div class="role-icon">ğŸšš</div><h3>Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„ØªÙˆØµÙŠÙ„</h3><span>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„ØªØ³Ù„ÙŠÙ…</span></div>
  </div>
</div>

<div class="app" id="delegateApp">
  <div class="topbar"><div class="topbar-right"><h2>ğŸ“‹ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h2><span class="user-role">Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ</span></div><button class="btn-back" onclick="goBack()">â† ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±</button></div>
  <div class="main">
    <div class="stats fade-up">
      <div class="stat-card"><div class="label">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div><div class="value" id="todayVisits">0</div></div>
      <div class="stat-card"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div><div class="value" id="totalClients">0</div></div>
      <div class="stat-card"><div class="label">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯</div><div class="value" id="pendingCount">0</div></div>
      <div class="stat-card"><div class="label">Ù…Ø´Ø§Ø±ÙŠØ¹ ÙØ¹Ù‘Ø§Ù„Ø©</div><div class="value" id="activeProjects">0</div></div>
    </div>
    <div class="section-header fade-up fade-up-1"><h3>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3><button class="btn btn-primary" onclick="openModal('visitModal')">+ ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button></div>
    <div class="list fade-up fade-up-2" id="visitsList"></div>
  </div>
</div>

<div class="app" id="supervisorApp">
  <div class="topbar"><div class="topbar-right"><h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</h2><span class="user-role">ÙÙ‡Ø¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ</span></div><button class="btn-back" onclick="goBack()">â† ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±</button></div>
  <div class="main">
    <div class="stats fade-up">
      <div class="stat-card"><div class="label">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div><div class="value" id="supNew">0</div></div>
      <div class="stat-card"><div class="label">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶</div><div class="value" id="supPending">0</div></div>
      <div class="stat-card"><div class="label">Ø¹Ø±ÙˆØ¶ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„</div><div class="value" id="supReady">0</div></div>
      <div class="stat-card"><div class="label">Ù…Ø´Ø§Ø±ÙŠØ¹ Ù†Ø´Ø·Ø©</div><div class="value" id="supActive">0</div></div>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="switchSupTab(this,'supVisits')">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</button>
      <button class="tab" onclick="switchSupTab(this,'supQuotes')">Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„</button>
      <button class="tab" onclick="switchSupTab(this,'supProjects')">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
    </div>
    <div id="supVisits" class="tab-content"><div class="list" id="supVisitsList"></div></div>
    <div id="supQuotes" class="tab-content" style="display:none"><div class="list" id="supQuotesList"></div></div>
    <div id="supProjects" class="tab-content" style="display:none"><div class="list" id="supProjectsList"></div></div>
  </div>
</div>

<div class="app" id="deliveryApp">
  <div class="topbar"><div class="topbar-right"><h2>ğŸšš Ù„ÙˆØ­Ø© Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„ØªÙˆØµÙŠÙ„</h2><span class="user-role">Ø³Ø¹Ø¯ Ø§Ù„Ø´Ù…Ø±ÙŠ</span></div><button class="btn-back" onclick="goBack()">â† ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±</button></div>
  <div class="main">
    <div class="stats fade-up">
      <div class="stat-card"><div class="label">Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¬Ø§Ø±ÙŠØ©</div><div class="value" id="delActive">0</div></div>
      <div class="stat-card"><div class="label">Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ³Ù„ÙŠÙ…</div><div class="value" id="delReady">0</div></div>
      <div class="stat-card"><div class="label">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</div><div class="value" id="delDone">0</div></div>
    </div>
    <div class="section-header fade-up fade-up-1"><h3>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø³Ù†Ø¯Ø©</h3></div>
    <div class="list fade-up fade-up-2" id="delProjectsList"></div>
  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="visitModal"><div class="modal"><div class="modal-header"><h3>ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3><button class="modal-close" onclick="closeModal('visitModal')">âœ•</button></div><div class="modal-body">
  <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input type="text" id="clientName" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±ÙƒØ© Ø§Ù„Ø£ÙÙ‚ Ù„Ù„ØªØ¬Ø§Ø±Ø©"></div>
  <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label><input type="text" id="clientPhone" placeholder="05xxxxxxxx"></div>
  <div class="form-group"><label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="clientLocation" placeholder="Ù…Ø«Ø§Ù„: Ø­ÙŠ Ø§Ù„Ù†Ø±Ø¬Ø³ - Ø§Ù„Ø±ÙŠØ§Ø¶"></div>
  <div class="form-group"><label>Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</label><div class="chips" id="serviceChips"></div></div>
  <div class="form-group"><label>Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="clientNeeds" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„..."></textarea></div>
  <div class="form-group"><label>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label><select id="visitPriority"><option value="Ø¹Ø§Ø¯ÙŠ">Ø¹Ø§Ø¯ÙŠ</option><option value="Ù…Ù‡Ù…">Ù…Ù‡Ù…</option><option value="Ø¹Ø§Ø¬Ù„">Ø¹Ø§Ø¬Ù„</option></select></div>
  <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:.5rem" onclick="saveVisit()">Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø© âœ“</button>
</div></div></div>

<div class="modal-overlay" id="waModal"><div class="modal wide"><div class="modal-header"><h3>Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¹Ø±ÙˆØ¶ Ø£Ø³Ø¹Ø§Ø±</h3><button class="modal-close" onclick="closeModal('waModal')">âœ•</button></div><div class="modal-body"><div id="waContent"></div></div></div></div>
<div class="modal-overlay" id="aiModal"><div class="modal wide"><div class="modal-header"><h3>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3><button class="modal-close" onclick="closeModal('aiModal')">âœ•</button></div><div class="modal-body"><div id="aiContent"></div></div></div></div>
<div class="modal-overlay" id="projectModal"><div class="modal wide"><div class="modal-header"><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3><button class="modal-close" onclick="closeModal('projectModal')">âœ•</button></div><div class="modal-body"><div id="projectContent"></div></div></div></div>
<div class="modal-overlay" id="quoteModal"><div class="modal"><div class="modal-header"><h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø³Ø¹Ø±</h3><button class="modal-close" onclick="closeModal('quoteModal')">âœ•</button></div><div class="modal-body"><div id="quoteFormContent"></div></div></div></div>
<div class="modal-overlay" id="updateModal"><div class="modal"><div class="modal-header"><h3>Ø¥Ø¶Ø§ÙØ© ØªØ­Ø¯ÙŠØ«</h3><button class="modal-close" onclick="closeModal('updateModal')">âœ•</button></div><div class="modal-body"><div class="form-group"><label>Ø§Ù„ØªØ­Ø¯ÙŠØ«</label><textarea id="updateText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«..."></textarea></div><button class="btn btn-primary" style="width:100%;justify-content:center" onclick="saveUpdate()">Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«</button></div></div></div>

<script>
const SERVICES=["ØªØµÙ…ÙŠÙ… Ø¯Ø§Ø®Ù„ÙŠ","ØµÙŠØ§Ù†Ø© Ù…Ø¨Ø§Ù†ÙŠ","ØªÙƒÙŠÙŠÙ ÙˆØªØ¨Ø±ÙŠØ¯","ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø©","Ø´Ø¨ÙƒØ§Øª ÙˆØªÙ…Ø¯ÙŠØ¯Ø§Øª","Ù†Ø¸Ø§ÙØ© ÙˆØªØ¹Ù‚ÙŠÙ…","Ø¯Ù‡Ø§Ù†Ø§Øª ÙˆØ¯ÙŠÙƒÙˆØ±","Ø³Ø¨Ø§ÙƒØ©","ÙƒÙ‡Ø±Ø¨Ø§Ø¡","Ù„Ø§Ù†Ø¯Ø³ÙƒÙŠØ¨ ÙˆØ­Ø¯Ø§Ø¦Ù‚","Ø¹Ø²Ù„ Ù…Ø§Ø¦ÙŠ ÙˆØ­Ø±Ø§Ø±ÙŠ","Ø£Ù†Ø¸Ù…Ø© Ø£Ù…Ù†ÙŠØ©"];
const SUPPLIERS=[
  {id:1,name:"Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ÙØ§Ø±Ø³",services:["ØªØµÙ…ÙŠÙ… Ø¯Ø§Ø®Ù„ÙŠ","Ø¯Ù‡Ø§Ù†Ø§Øª ÙˆØ¯ÙŠÙƒÙˆØ±"],phone:"0501234567",rating:4.5},
  {id:2,name:"Ø´Ø±ÙƒØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¯ÙŠØ«",services:["ØµÙŠØ§Ù†Ø© Ù…Ø¨Ø§Ù†ÙŠ","Ø³Ø¨Ø§ÙƒØ©","ÙƒÙ‡Ø±Ø¨Ø§Ø¡"],phone:"0559876543",rating:4.2},
  {id:3,name:"Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©",services:["ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø©","Ø´Ø¨ÙƒØ§Øª ÙˆØªÙ…Ø¯ÙŠØ¯Ø§Øª","Ø£Ù†Ø¸Ù…Ø© Ø£Ù…Ù†ÙŠØ©"],phone:"0543216789",rating:4.7},
  {id:4,name:"Ø´Ø±ÙƒØ© Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©",services:["Ù†Ø¸Ø§ÙØ© ÙˆØªØ¹Ù‚ÙŠÙ…"],phone:"0567891234",rating:3.9},
  {id:5,name:"Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ÙˆØ§Ø­Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡",services:["Ù„Ø§Ù†Ø¯Ø³ÙƒÙŠØ¨ ÙˆØ­Ø¯Ø§Ø¦Ù‚"],phone:"0534567891",rating:4.4},
  {id:6,name:"Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ø²Ù„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…",services:["Ø¹Ø²Ù„ Ù…Ø§Ø¦ÙŠ ÙˆØ­Ø±Ø§Ø±ÙŠ","ØµÙŠØ§Ù†Ø© Ù…Ø¨Ø§Ù†ÙŠ"],phone:"0512345678",rating:4.1},
  {id:7,name:"Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ù„Ù„ØªØµÙ…ÙŠÙ…",services:["ØªØµÙ…ÙŠÙ… Ø¯Ø§Ø®Ù„ÙŠ","Ø¯Ù‡Ø§Ù†Ø§Øª ÙˆØ¯ÙŠÙƒÙˆØ±","Ù„Ø§Ù†Ø¯Ø³ÙƒÙŠØ¨ ÙˆØ­Ø¯Ø§Ø¦Ù‚"],phone:"0598765432",rating:4.8},
  {id:8,name:"Ø´Ø±ÙƒØ© Ø§Ù„ØªØ¨Ø±ÙŠØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹",services:["ØªÙƒÙŠÙŠÙ ÙˆØªØ¨Ø±ÙŠØ¯","ÙƒÙ‡Ø±Ø¨Ø§Ø¡"],phone:"0521234567",rating:4.0},
  {id:9,name:"Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©",services:["ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø©","Ø£Ù†Ø¸Ù…Ø© Ø£Ù…Ù†ÙŠØ©","Ø´Ø¨ÙƒØ§Øª ÙˆØªÙ…Ø¯ÙŠØ¯Ø§Øª"],phone:"0587654321",rating:4.6},
  {id:10,name:"Ø´Ø±ÙƒØ© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©",services:["ØµÙŠØ§Ù†Ø© Ù…Ø¨Ø§Ù†ÙŠ","Ø³Ø¨Ø§ÙƒØ©","ÙƒÙ‡Ø±Ø¨Ø§Ø¡","ØªÙƒÙŠÙŠÙ ÙˆØªØ¨Ø±ÙŠØ¯"],phone:"0541237894",rating:3.8}
];
let visits=[],projects=[],currentVisitId=null,currentProjectId=null,selectedServices=new Set();

function selectRole(r){document.getElementById('roleScreen').style.display='none';document.querySelectorAll('.app').forEach(a=>a.classList.remove('active'));if(r==='delegate'){document.getElementById('delegateApp').classList.add('active');renderDelegateView()}else if(r==='supervisor'){document.getElementById('supervisorApp').classList.add('active');renderSupervisorView()}else{document.getElementById('deliveryApp').classList.add('active');renderDeliveryView()}}
function goBack(){document.querySelectorAll('.app').forEach(a=>a.classList.remove('active'));document.getElementById('roleScreen').style.display='flex'}
function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active')})});
function formatDate(d){return new Date(d).toLocaleDateString('ar-SA',{year:'numeric',month:'short',day:'numeric'})}

function renderServiceChips(){document.getElementById('serviceChips').innerHTML=SERVICES.map(s=>`<button class="chip ${selectedServices.has(s)?'selected':''}" onclick="toggleService('${s}')">${s}</button>`).join('')}
function toggleService(s){selectedServices.has(s)?selectedServices.delete(s):selectedServices.add(s);renderServiceChips()}
renderServiceChips();

function saveVisit(){
  const n=document.getElementById('clientName').value.trim(),ph=document.getElementById('clientPhone').value.trim(),loc=document.getElementById('clientLocation').value.trim(),needs=document.getElementById('clientNeeds').value.trim(),pri=document.getElementById('visitPriority').value;
  if(!n||selectedServices.size===0){alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');return}
  visits.push({id:Date.now().toString(36),clientName:n,phone:ph,location:loc,services:[...selectedServices],needs,priority:pri,status:'Ø¬Ø¯ÙŠØ¯',date:new Date().toISOString(),rep:'Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ',quotes:[],sentToSuppliers:false});
  ['clientName','clientPhone','clientLocation','clientNeeds'].forEach(x=>document.getElementById(x).value='');
  document.getElementById('visitPriority').value='Ø¹Ø§Ø¯ÙŠ';selectedServices.clear();renderServiceChips();closeModal('visitModal');renderDelegateView();
}

function renderDelegateView(){
  document.getElementById('todayVisits').textContent=visits.length;document.getElementById('totalClients').textContent=visits.length;
  document.getElementById('pendingCount').textContent=visits.filter(v=>v.status==='Ø¬Ø¯ÙŠØ¯'||v.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶').length;
  document.getElementById('activeProjects').textContent=projects.filter(p=>p.status!=='ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…').length;
  const l=document.getElementById('visitsList');
  if(!visits.length){l.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯<br>Ø§Ø¶ØºØ· "ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡</p></div>';return}
  l.innerHTML=visits.map(v=>{const b=v.priority==='Ø¹Ø§Ø¬Ù„'?'badge-red':v.priority==='Ù…Ù‡Ù…'?'badge-amber':'badge-blue';const s=v.status==='Ø¬Ø¯ÙŠØ¯'?'badge-blue':v.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶'?'badge-amber':v.status==='ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶'?'badge-cyan':v.status==='Ù…Ù‚Ø¨ÙˆÙ„'?'badge-green':'badge-purple';return`<div class="list-item"><div class="list-item-top"><h4>${v.clientName}</h4><div style="display:flex;gap:.5rem"><span class="badge ${b}">${v.priority}</span><span class="badge ${s}">${v.status}</span></div></div><p>${v.needs||'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}</p><div class="meta"><span>ğŸ“ ${v.location||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span><span>ğŸ“ ${v.phone||'-'}</span><span>ğŸ“… ${formatDate(v.date)}</span><span>ğŸ”§ ${v.services.join('ØŒ ')}</span></div></div>`}).join('');
}

function switchSupTab(btn,tabId){document.querySelectorAll('#supervisorApp .tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');document.querySelectorAll('#supervisorApp .tab-content').forEach(t=>t.style.display='none');document.getElementById(tabId).style.display='block'}

function getMatchingSuppliers(svcs){return SUPPLIERS.filter(s=>s.services.some(ss=>svcs.includes(ss)))}

function renderSupervisorView(){
  document.getElementById('supNew').textContent=visits.filter(v=>v.status==='Ø¬Ø¯ÙŠØ¯').length;
  document.getElementById('supPending').textContent=visits.filter(v=>v.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶').length;
  document.getElementById('supReady').textContent=visits.filter(v=>v.quotes.length>=2).length;
  document.getElementById('supActive').textContent=projects.filter(p=>p.status!=='ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…').length;
  const vl=document.getElementById('supVisitsList'),pv=visits.filter(v=>v.status!=='Ù…Ù‚Ø¨ÙˆÙ„');
  if(!pv.length)vl.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø±Ø¯Ø©</p></div>';
  else vl.innerHTML=pv.map(v=>{const sb=v.status==='Ø¬Ø¯ÙŠØ¯'?'badge-blue':v.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶'?'badge-amber':v.status==='ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶'?'badge-cyan':'badge-green';const sup=getMatchingSuppliers(v.services);return`<div class="list-item"><div class="list-item-top"><h4>${v.clientName}</h4><span class="badge ${sb}">${v.status}</span></div><p>Ø§Ù„Ø®Ø¯Ù…Ø§Øª: ${v.services.join('ØŒ ')}</p><p style="color:var(--text3);font-size:.82rem">Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª: ${v.needs||'-'}</p><div class="meta"><span>ğŸ‘¤ ${v.rep}</span><span>ğŸ“… ${formatDate(v.date)}</span><span>ğŸ¢ ${sup.length} Ù…ÙˆØ±Ø¯ Ù…ØªØ§Ø­</span><span>ğŸ“ ${v.quotes.length} Ø¹Ø±Ø¶ ÙˆØ§Ø±Ø¯</span></div><div style="display:flex;gap:.5rem;margin-top:.8rem;flex-wrap:wrap">${!v.sentToSuppliers?`<button class="btn btn-whatsapp btn-sm" onclick="openWhatsApp('${v.id}')">ğŸ“± Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</button>`:''}<button class="btn btn-outline btn-sm" onclick="openAddQuote('${v.id}')">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø³Ø¹Ø±</button>${v.quotes.length>=2?`<button class="btn btn-primary btn-sm" onclick="runAIAnalysis('${v.id}')">âœ¦ ØªØ­Ù„ÙŠÙ„ AI</button>`:''}${v.status==='ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶'?`<button class="btn btn-green btn-sm" onclick="acceptBestQuote('${v.id}')">âœ“ Ù‚Ø¨ÙˆÙ„ ÙˆÙØªØ­ Ù…Ø´Ø±ÙˆØ¹</button>`:''}</div></div>`}).join('');
  const pl=document.getElementById('supProjectsList');
  if(!projects.length)pl.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯</p></div>';
  else pl.innerHTML=projects.map(p=>{const sb=p.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°'?'badge-purple':p.status==='ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'?'badge-green':'badge-amber';return`<div class="list-item" onclick="openProjectDetail('${p.id}')"><div class="list-item-top"><h4>Ù…Ø´Ø±ÙˆØ¹: ${p.clientName}</h4><span class="badge ${sb}">${p.status}</span></div><p>Ø§Ù„Ù…ÙˆØ±Ø¯: ${p.supplier} | Ø§Ù„Ù…Ø¨Ù„Øº: ${p.price.toLocaleString()} Ø±.Ø³ | Ø§Ù„Ù…Ø¯Ø©: ${p.duration} ÙŠÙˆÙ…</p><div class="meta"><span>ğŸ“… ${formatDate(p.date)}</span><span>ğŸ“ ${p.updates.length} ØªØ­Ø¯ÙŠØ«</span></div></div>`}).join('');
  renderQuotesTab();
}

function renderQuotesTab(){
  const ql=document.getElementById('supQuotesList'),wq=visits.filter(v=>v.quotes.length>0);
  if(!wq.length){ql.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ø±Ø¯Ø© Ø¨Ø¹Ø¯</p></div>';return}
  ql.innerHTML=wq.map(v=>`<div class="list-item"><h4 style="margin-bottom:.8rem">${v.clientName} â€” ${v.services.join('ØŒ ')}</h4><table class="quote-table"><tr><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ù…Ø¯Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…</th><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th></tr>${v.quotes.map(q=>`<tr class="${q.best?'best-row':''}"><td>${q.supplier}${q.best?' â­':''}</td><td>${q.price.toLocaleString()} Ø±.Ø³</td><td>${q.duration} ÙŠÙˆÙ…</td><td>${'â˜…'.repeat(Math.floor(q.rating))}${'â˜†'.repeat(5-Math.floor(q.rating))} ${q.rating}</td></tr>`).join('')}</table></div>`).join('');
}

function openWhatsApp(vid){
  const v=visits.find(x=>x.id===vid);if(!v)return;const sup=getMatchingSuppliers(v.services);
  const msg=`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ğŸ™\n\nÙ†Ø­ØªØ§Ø¬ Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:\n${v.services.map(s=>'â€¢ '+s).join('\n')}\n\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${v.clientName}\nØ§Ù„Ù…ÙˆÙ‚Ø¹: ${v.location||'ÙŠØ­Ø¯Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹'}\n\nØ§Ù„Ù…Ø·Ù„ÙˆØ¨:\n${v.needs||'Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©'}\n\nÙ†Ø±Ø¬Ùˆ Ø¥Ø±Ø³Ø§Ù„:\n1ï¸âƒ£ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ\n2ï¸âƒ£ Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°/Ø§Ù„ØªØ³Ù„ÙŠÙ…\n\nØ´Ø§ÙƒØ±ÙŠÙ† ØªØ¹Ø§ÙˆÙ†ÙƒÙ… ğŸ¤`;
  document.getElementById('waContent').innerHTML=`<p style="color:var(--text2);margin-bottom:1rem;font-size:.9rem">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† (${sup.length} Ù…ÙˆØ±Ø¯):</p><div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1.5rem">${sup.map(s=>`<span class="badge badge-green">${s.name} â€” ${s.phone}</span>`).join('')}</div><p style="color:var(--text2);margin-bottom:.5rem;font-size:.85rem">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</p><div class="wa-preview"><div class="wa-bubble">${msg.replace(/\n/g,'<br>')}<div class="wa-time">${new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'})}</div></div></div><div style="display:flex;gap:.8rem;margin-top:1.5rem;flex-wrap:wrap">${sup.map(s=>`<a href="https://wa.me/${s.phone.replace(/^0/,'966')}?text=${encodeURIComponent(msg)}" target="_blank" class="btn btn-whatsapp btn-sm" style="text-decoration:none">ğŸ“± ${s.name}</a>`).join('')}</div><button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:1rem" onclick="markSent('${vid}')">âœ“ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â€” ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>`;
  openModal('waModal');
}
function markSent(vid){const v=visits.find(x=>x.id===vid);if(v){v.sentToSuppliers=true;v.status='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶'}closeModal('waModal');renderSupervisorView()}

function openAddQuote(vid){
  currentVisitId=vid;const v=visits.find(x=>x.id===vid),sup=getMatchingSuppliers(v.services);
  document.getElementById('quoteFormContent').innerHTML=`<div class="form-group"><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><select id="quoteSupplier">${sup.map(s=>`<option value="${s.name}" data-rating="${s.rating}">${s.name} (â˜… ${s.rating})</option>`).join('')}</select></div><div class="form-group"><label>Ø§Ù„Ø³Ø¹Ø± (Ø±.Ø³)</label><input type="number" id="quotePrice" placeholder="Ù…Ø«Ø§Ù„: 15000"></div><div class="form-group"><label>Ù…Ø¯Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label><input type="number" id="quoteDuration" placeholder="Ù…Ø«Ø§Ù„: 14"></div><button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:.5rem" onclick="saveQuote()">Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶</button>`;
  openModal('quoteModal');
}
function saveQuote(){
  const s=document.getElementById('quoteSupplier'),p=parseFloat(document.getElementById('quotePrice').value),d=parseInt(document.getElementById('quoteDuration').value);
  if(!p||!d){alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø¯Ø©');return}
  visits.find(x=>x.id===currentVisitId).quotes.push({supplier:s.value,price:p,duration:d,rating:parseFloat(s.selectedOptions[0].dataset.rating),best:false});
  closeModal('quoteModal');renderSupervisorView();
}

function runAIAnalysis(vid){
  const v=visits.find(x=>x.id===vid);if(!v||v.quotes.length<2){alert('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');return}
  const prices=v.quotes.map(q=>q.price),durs=v.quotes.map(q=>q.duration),minP=Math.min(...prices),maxP=Math.max(...prices),minD=Math.min(...durs),maxD=Math.max(...durs);
  v.quotes.forEach(q=>{const ps=maxP===minP?100:((maxP-q.price)/(maxP-minP))*100;const ds=maxD===minD?100:((maxD-q.duration)/(maxD-minD))*100;q.aiScore=Math.round(ps*.6+ds*.4);q.best=false});
  v.quotes.sort((a,b)=>b.aiScore-a.aiScore);v.quotes[0].best=true;v.status='ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶';
  const best=v.quotes[0],sav=maxP-best.price,ranks=['gold','silver','bronze'];
  document.getElementById('aiContent').innerHTML=`<div class="ai-box"><h4>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ â€” ${v.clientName}</h4><p style="font-size:.82rem;color:var(--text2);margin-bottom:1rem">ØªÙ… ØªØ­Ù„ÙŠÙ„ ${v.quotes.length} Ø¹Ø±ÙˆØ¶: <strong>Ø§Ù„Ø³Ø¹Ø± (60%)</strong> Ùˆ <strong>Ù…Ø¯Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (40%)</strong></p>${v.quotes.map((q,i)=>`<div class="ai-score"${q.best?' style="border:1px solid var(--green-border)"':''}><div class="rank ${ranks[i]||''}">${i+1}</div><div class="details"><h5>${q.supplier}${q.best?' ğŸ‘‘':''}</h5><p>${q.price.toLocaleString()} Ø±.Ø³ â€” ${q.duration} ÙŠÙˆÙ…</p></div><div class="score-val">${q.aiScore}%</div></div>`).join('')}<div class="ai-recommendation">âœ¦ Ø§Ù„ØªÙˆØµÙŠØ©: <strong>${best.supplier}</strong> Ø¨Ù†ØªÙŠØ¬Ø© ${best.aiScore}% â€” ${best.price.toLocaleString()} Ø±.Ø³ Ø®Ù„Ø§Ù„ ${best.duration} ÙŠÙˆÙ…${sav>0?` (ØªÙˆÙÙŠØ± ${sav.toLocaleString()} Ø±.Ø³)`:''}</div></div>`;
  openModal('aiModal');renderSupervisorView();
}

function acceptBestQuote(vid){
  const v=visits.find(x=>x.id===vid),bq=v.quotes.find(q=>q.best);if(!bq){alert('ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ ØªØ­Ù„ÙŠÙ„ AI Ø£ÙˆÙ„Ø§Ù‹');return}
  v.status='Ù…Ù‚Ø¨ÙˆÙ„';
  projects.push({id:Date.now().toString(36),visitId:v.id,clientName:v.clientName,phone:v.phone,location:v.location,services:v.services,supplier:bq.supplier,price:bq.price,duration:bq.duration,status:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°',date:new Date().toISOString(),updates:[{text:'ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ¥Ø³Ù†Ø§Ø¯Ù‡ Ù„Ù„Ù…ÙˆØ±Ø¯ '+bq.supplier,date:new Date().toISOString(),user:'Ø§Ù„Ù†Ø¸Ø§Ù…'}]});
  renderSupervisorView();alert('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­!');
}

function openProjectDetail(pid){
  currentProjectId=pid;const p=projects.find(x=>x.id===pid);if(!p)return;
  const sb=p.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°'?'badge-purple':p.status==='Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…'?'badge-amber':'badge-green';
  document.getElementById('projectContent').innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem"><div><h4 style="font-size:1.1rem">${p.clientName}</h4><p style="font-size:.85rem;color:var(--text2)">${p.services.join('ØŒ ')}</p></div><span class="badge ${sb}">${p.status}</span></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:1.5rem"><div class="stat-card"><div class="label">Ø§Ù„Ù…ÙˆØ±Ø¯</div><div style="font-size:.95rem;font-weight:600">${p.supplier}</div></div><div class="stat-card"><div class="label">Ø§Ù„Ù…Ø¨Ù„Øº</div><div style="font-size:.95rem;font-weight:600">${p.price.toLocaleString()} Ø±.Ø³</div></div><div class="stat-card"><div class="label">Ø§Ù„Ù…Ø¯Ø©</div><div style="font-size:.95rem;font-weight:600">${p.duration} ÙŠÙˆÙ…</div></div></div><h4 style="margin-bottom:1rem;font-size:.95rem">Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</h4><div class="timeline" style="margin-bottom:1.5rem">${p.updates.map(u=>`<div class="timeline-item done"><div class="t-date">${formatDate(u.date)}</div><div class="t-content">${u.text}</div><div class="t-user">${u.user}</div></div>`).join('')}</div><div style="display:flex;gap:.5rem;flex-wrap:wrap"><button class="btn btn-primary btn-sm" onclick="closeModal('projectModal');openModal('updateModal')">+ Ø¥Ø¶Ø§ÙØ© ØªØ­Ø¯ÙŠØ«</button>${p.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°'?`<button class="btn btn-amber btn-sm" onclick="changeProjectStatus('${p.id}','Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…')">ğŸ“¦ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…</button>`:''}${p.status==='Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…'?`<button class="btn btn-green btn-sm" onclick="changeProjectStatus('${p.id}','ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…')">âœ“ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>`:''}</div>`;
  openModal('projectModal');
}

function saveUpdate(){const t=document.getElementById('updateText').value.trim();if(!t)return;const p=projects.find(x=>x.id===currentProjectId);if(p)p.updates.push({text:t,date:new Date().toISOString(),user:'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'});document.getElementById('updateText').value='';closeModal('updateModal');renderSupervisorView();renderDeliveryView()}
function changeProjectStatus(pid,ns){const p=projects.find(x=>x.id===pid);if(p){p.status=ns;p.updates.push({text:'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰: '+ns,date:new Date().toISOString(),user:'Ø§Ù„Ù†Ø¸Ø§Ù…'})}closeModal('projectModal');renderSupervisorView();renderDeliveryView()}

function renderDeliveryView(){
  document.getElementById('delActive').textContent=projects.filter(p=>p.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°').length;
  document.getElementById('delReady').textContent=projects.filter(p=>p.status==='Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…').length;
  document.getElementById('delDone').textContent=projects.filter(p=>p.status==='ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…').length;
  const l=document.getElementById('delProjectsList');
  if(!projects.length){l.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸšš</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø³Ù†Ø¯Ø© Ø¨Ø¹Ø¯</p></div>';return}
  l.innerHTML=projects.map(p=>{const sb=p.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°'?'badge-purple':p.status==='Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…'?'badge-amber':'badge-green';return`<div class="list-item" onclick="openProjectDetail('${p.id}')"><div class="list-item-top"><h4>${p.clientName}</h4><span class="badge ${sb}">${p.status}</span></div><p>Ø§Ù„Ù…ÙˆØ±Ø¯: ${p.supplier} | ${p.services.join('ØŒ ')}</p><div class="meta"><span>ğŸ’° ${p.price.toLocaleString()} Ø±.Ø³</span><span>â±ï¸ ${p.duration} ÙŠÙˆÙ…</span><span>ğŸ“ ${p.location||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span><span>ğŸ“ ${p.phone||'-'}</span></div><div style="margin-top:.8rem;display:flex;gap:.5rem;flex-wrap:wrap">${p.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°'?`<button class="btn btn-amber btn-sm" onclick="event.stopPropagation();changeProjectStatus('${p.id}','Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…')">ğŸ“¦ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…</button>`:''}${p.status==='Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…'?`<button class="btn btn-green btn-sm" onclick="event.stopPropagation();changeProjectStatus('${p.id}','ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…')">âœ“ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>`:''}<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();currentProjectId='${p.id}';openModal('updateModal')">+ ØªØ­Ø¯ÙŠØ«</button></div></div>`}).join('');
}

// Demo Data
visits=[
  {id:'d1',clientName:'Ø´Ø±ÙƒØ© Ø§Ù„Ø£ÙÙ‚ Ù„Ù„ØªØ¬Ø§Ø±Ø©',phone:'0551234567',location:'Ø­ÙŠ Ø§Ù„Ù†Ø±Ø¬Ø³ - Ø§Ù„Ø±ÙŠØ§Ø¶',services:['ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø©','Ø£Ù†Ø¸Ù…Ø© Ø£Ù…Ù†ÙŠØ©'],needs:'ØªØ±ÙƒÙŠØ¨ 20 ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ÙˆØ®Ø§Ø±Ø¬ÙŠØ© Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø¥Ù†Ø°Ø§Ø±',priority:'Ø¹Ø§Ø¬Ù„',status:'ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶',date:'2026-02-03T10:30:00',rep:'Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ',sentToSuppliers:true,quotes:[{supplier:'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©',price:45000,duration:7,rating:4.7,aiScore:95,best:true},{supplier:'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©',price:52000,duration:10,rating:4.6,aiScore:62,best:false}]},
  {id:'d2',clientName:'Ù…Ø¬Ù…Ø¹ Ø§Ù„ÙŠØ§Ø³Ù…ÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠ',phone:'0509876543',location:'Ø­ÙŠ Ø§Ù„ÙŠØ§Ø³Ù…ÙŠÙ† - Ø§Ù„Ø±ÙŠØ§Ø¶',services:['ØªÙƒÙŠÙŠÙ ÙˆØªØ¨Ø±ÙŠØ¯','ØµÙŠØ§Ù†Ø© Ù…Ø¨Ø§Ù†ÙŠ'],needs:'ØµÙŠØ§Ù†Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªÙƒÙŠÙŠÙ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ - 3 Ø£Ø¯ÙˆØ§Ø±',priority:'Ù…Ù‡Ù…',status:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶',date:'2026-02-04T09:00:00',rep:'Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ',sentToSuppliers:true,quotes:[]},
  {id:'d3',clientName:'ÙÙ†Ø¯Ù‚ Ø§Ù„Ù‚ØµØ± Ø§Ù„Ø°Ù‡Ø¨ÙŠ',phone:'0543219876',location:'Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯ - Ø¬Ø¯Ø©',services:['ØªØµÙ…ÙŠÙ… Ø¯Ø§Ø®Ù„ÙŠ','Ø¯Ù‡Ø§Ù†Ø§Øª ÙˆØ¯ÙŠÙƒÙˆØ±','Ù„Ø§Ù†Ø¯Ø³ÙƒÙŠØ¨ ÙˆØ­Ø¯Ø§Ø¦Ù‚'],needs:'ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆØ¨ÙŠ ÙˆØ§Ù„Ø­Ø¯Ø§Ø¦Ù‚ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©',priority:'Ø¹Ø§Ø¯ÙŠ',status:'Ø¬Ø¯ÙŠØ¯',date:'2026-02-04T14:20:00',rep:'Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ',sentToSuppliers:false,quotes:[]}
];
projects=[{id:'p1',visitId:'d0',clientName:'Ù…ØµÙ†Ø¹ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù„Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒ',phone:'0561112233',location:'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© - Ø§Ù„Ø±ÙŠØ§Ø¶',services:['ÙƒÙ‡Ø±Ø¨Ø§Ø¡','Ø³Ø¨Ø§ÙƒØ©'],supplier:'Ø´Ø±ÙƒØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¯ÙŠØ«',price:38000,duration:12,status:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°',date:'2026-01-28T08:00:00',updates:[{text:'ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ¥Ø³Ù†Ø§Ø¯Ù‡ Ù„Ù„Ù…ÙˆØ±Ø¯ Ø´Ø±ÙƒØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¯ÙŠØ«',date:'2026-01-28T08:00:00',user:'Ø§Ù„Ù†Ø¸Ø§Ù…'},{text:'ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙ…Ø¯ÙŠØ¯Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© ÙÙŠ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø£Ø±Ø¶ÙŠ',date:'2026-01-30T11:00:00',user:'Ø§Ù„Ù…Ø´Ø±Ù'},{text:'Ø§ÙƒØªÙ…Ø§Ù„ 40% Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©ØŒ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø³Ø¨Ø§ÙƒØ©',date:'2026-02-02T09:30:00',user:'Ø§Ù„Ù…ÙˆØ±Ø¯'}]}];
</script>
</body>
</html>
